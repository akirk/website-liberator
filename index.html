<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style>
		body {
			font-family: sans-serif;
			font-size: 14px;
			margin: 0;
		}
		.container {
			display: flex;
			height: 100vh;
			width: 100vw;
		}

		form {
			margin-top: 2em;
		}

		.chat {
			flex: 1;
			background-color: #fff;
			display: flex;
			flex-direction: column;
			width: 20vw;
		}

		#preview {
			flex: 5;
			padding: 20px;
			border-left: 3px solid #9bb;
		}

		#wp {
			width: 80vw;
			height: 90vh;
		}
		#messages {
			height: 70vh;
			overflow-y: scroll;
			flex: 8;
			padding: 10px;
		}
		#messages li {
			list-style-type: none;
			background: white;
			margin-bottom: .5em;

		}
		#messages li:first-child {
			font-weight: bold;
			border-bottom: 1px solid #bbb;
		}
		#messages li:hover {
			background: #eee;
		}
		#samples li {
			list-style-type: none;
			padding: .1em;
			padding-left: 1em;
			margin-bottom: .1em;
			font-size: 12px;
		}
		#chat-form {
			flex: 1;
			border-top: 1px solid #999;
			height: 30vh;
		}
		#update-page {
			display: none;
		}
		#tabs  {
			display: inline;
		}
		#tabs li {
			display: inline;
			margin-left: .5em;
			text-decoration: underline;
		}
		#tabs li.active {
			font-weight: bold;
			text-decoration: none;
		}
		li span.date {
			color: #999;
			font-size: 12px;
			padding-left: .5em;
		}
		li div {
			margin-bottom: .2em;
		}
		form {
			margin-top: .5em;
			padding: .5em;
			margin-bottom: 20px;
		}
		button, input {
			margin-top: .5em;
		}
		input {
			width: 12vw;
		}
		ul {
			margin: 0;
			padding:0;
		}
		#tabs-holder  {
			border-bottom: 1px solid #bbb;
			padding: 7px 10px 5px 10px;
		}
		#chat-form ul li {
			cursor: pointer;
		}
		code {
			font-size: 10px;
			padding: .3em;
		}
		#spinner {
			margin-top: .5em;
			width: 10px;
			height: 10px;
			border: 3px solid #f3f3f3;
			border-top: 3px solid #3498db;
			border-radius: 50%;
			animation: spin 2s linear infinite;
		}

		@keyframes spin {
		  0% { transform: rotate(0deg); }
		  100% {transform: rotate(360deg); }
		}
		#update-page details {
			margin-top: .5em;
		}
		details summary {
			cursor: pointer;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="chat">
			<ul id="messages">
				<li>Website Liberator Bot</li>
			</ul>
			<div id="chat-form">
				<div id="tabs-holder">Input: <ul id="tabs"><li class="active">Image</li><li>Text</li></ul>
				</div>
				<form id="upload-image">
					Please choose a screenshot:
					<input type="file" id="image-upload" accept="image/*" />
					<button type="submit" id="submit-button">Update front page</button>
				</form>

				<form id="update-page">
					<input type="text" value="" placeholder="Enter your message" />
					<button type="submit" id="submit-button">&gt;</button>
				<details><summary>Sample Inputs</summary>
				<ul id="samples">
					<li>update the headline on the frontpage to "Hello" </li>
					<li>Set the site title to "Hello"</li>
					<li>delete the page titled "Sample Page"</li>
				</ul></details>
				</form>
			</div>
		</div>
		<div id="preview"><iframe id="wp"></iframe>
</div>
<script type="module">
	import { startPlaygroundWeb, phpVars } from 'https://unpkg.com/@wp-playground/client/index.js';
	let apiKey = localStorage.getItem( 'openAIkey' );
	if ( ! apiKey ) {
		apiKey = prompt( 'Please enter your OpenAI key, it will be saved to local storage:' );
		if ( apiKey ) {
			localStorage.setItem( 'openAIkey', apiKey );
		}
	}

	function getChatLi( name, prompt ) {
		const li = document.createElement('li');
		const date = new Date();

		let hour = date.getHours();
		let minutes = date.getMinutes();
		let seconds = date.getSeconds();

		// Formatting the time
		hour = (hour < 10 ? "0" : "") + hour;
		minutes = (minutes < 10 ? "0" : "") + minutes;
		seconds = (seconds < 10 ? "0" : "") + seconds;

		li.textContent = prompt;
		const div = document.createElement( 'div' );
		div.innerHTML='<strong>' + name + '</strong> <span class="date">' +  hour + ":" + minutes + ":" + seconds
		li.insertBefore( div, li.firstChild);
		if ( ! prompt ) {
			const spinner = document.createElement( 'div' );
			spinner.id = 'spinner';
			li.appendChild(spinner);
		}
		return li;
	}
	document.addEventListener('DOMContentLoaded', function() {
		document.getElementById( 'messages' ).appendChild( getChatLi( 'Bot', 'Hi! Loading WordPress... Please wait!' ));
		document.addEventListener('click', function(e) {
			if ( ! e.target.closest( 'ul#tabs' ) ) {
				return;
			}
			e.preventDefault();
			document.querySelectorAll('#tabs li').forEach(e=>e.className='');
			e.target.className = 'active';
			document.getElementById('upload-image').style.display = 'none';
			document.getElementById('update-page').style.display = 'none';
			if ( e.target.textContent === 'Image' ) {
			document.getElementById('upload-image').style.display = 'block';
			}
			if ( e.target.textContent === 'Text' ) {
			document.getElementById('update-page').style.display = 'block';
			document.querySelector('#update-page input').focus();


			}
		} );
		document.addEventListener('click', function(e) {
			if ( ! e.target.matches( 'ul#samples li' ) ) {
				return;
			}
			e.preventDefault();
			e.target.closest('form').querySelector('input').value = e.target.textContent;
		} );


		document.addEventListener('submit', function(e) {
			if ( ! e.target.matches( '#update-page' ) ) {
				return;
			}
			e.preventDefault();
			const input = e.target.querySelector('input');
			const prompt = input.value;
			if ( prompt.length === 0 ) {
				return;
			}
			const form = e.target;
			input.value = '';
			const b = form.querySelector('button');
			const li = getChatLi( 'Alex', prompt );
			const bot = getChatLi( 'Bot' );
			const m = document.getElementById( 'messages' );
			m.appendChild( li );
			m.appendChild( bot );
			m.scrollTop = m.scrollHeight;
			input.focus();
			if ( ! apiKey ) {
				bot.removeChild( document.getElementById('spinner') );
				const s = document.createElement( 'span' );
				s.textContent = 'No OpenAI key set.';
				bot.appendChild(s);
				return;
			}
			b.disabled = true;
			form.disabled = true;
			const data = {
				messages: [
					{
						role: 'system',
						content: 'You\'re here to help the user update their WordPress page. Instead of just telling the user what to do, use a function call to do the updates yourself. Dont ask for reconfirmations but act. If the user asks you to update something, fetch the contents first so that you know what it needs to be updated to. keep or update any html comments that might exist since they are needed for WordPresses gutenberg html.'
					},
					{
						role: 'user',
						content: prompt
					}
				],
				model: 'gpt-3.5-turbo',
			};

			openAI( data, async function( result ) {
				bot.removeChild( document.getElementById('spinner') );
				const details = document.createElement( 'details' );
				const summary = document.createElement( 'summary' );
				const c = document.createElement( 'code' );
				summary.textContent = 'Done!';
				c.textContent = result;
				details.appendChild(summary)
				details.appendChild(c);
				bot.appendChild( details );
				client.goTo( '/' );
			} ).then(()=>{b.disabled = false;form.disabled = false;})
		});

		const openai_functions = {
			get_page_contents: async function( vars ) {
				console.log(vars)
				const js = phpVars( vars );
				await client.isReady;
				let r = await client.run({
					code: `<?php
					require("/wordpress/wp-load.php");
					if ( ${js.path} === '/' || ${js.path} === 'frontpage'|| ${js.path} === '/frontpage' ) {
						$posts = get_posts( array(
							'post_name' => 'home',
							'post_type' => 'wp_template',
						) );
						if ( ! empty($posts)) {
							$page = $posts[0];
						} else {
							$block_template = get_block_template('twentytwentyfour//template-home-business');
							$page = (object) array(
								'post_content' => '<!-- wp:template-part {"slug":"header","theme":"twentytwentyfour","tagName":"header","area":"header"} /-->

<!-- wp:group {"tagName":"main","style":{"spacing":{"blockGap":"0","margin":{"top":"0"}}},"layout":{"type":"default"}} -->
<main class="wp-block-group" style="margin-top:0"><!-- wp:group {"align":"full","style":{"spacing":{"padding":{"top":"var:preset|spacing|50","bottom":"var:preset|spacing|50","left":"var:preset|spacing|50","right":"var:preset|spacing|50"}}},"layout":{"type":"constrained","contentSize":"","wideSize":""}} -->
<div class="wp-block-group alignfull" style="padding-top:var(--wp--preset--spacing--50);padding-right:var(--wp--preset--spacing--50);padding-bottom:var(--wp--preset--spacing--50);padding-left:var(--wp--preset--spacing--50)"><!-- wp:group {"style":{"spacing":{"blockGap":"0px"}},"layout":{"type":"constrained","contentSize":"565px"}} -->
<div class="wp-block-group"><!-- wp:heading {"textAlign":"center","level":1,"fontSize":"x-large"} -->
<h1 class="wp-block-heading has-text-align-center has-x-large-font-size">A commitment to innovation and sustainability</h1>
<!-- /wp:heading -->

<!-- wp:spacer {"height":"1.25rem"} -->
<div style="height:1.25rem" aria-hidden="true" class="wp-block-spacer"></div>
<!-- /wp:spacer -->

<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center">Ã‰tudes is a pioneering firm that seamlessly merges creativity and functionality to redefine architectural excellence.</p>
<!-- /wp:paragraph -->

<!-- wp:spacer {"height":"1.25rem"} -->
<div style="height:1.25rem" aria-hidden="true" class="wp-block-spacer"></div>
<!-- /wp:spacer -->

<!-- wp:buttons {"layout":{"type":"flex","justifyContent":"center"}} -->
<div class="wp-block-buttons"><!-- wp:button -->
<div class="wp-block-button"><a class="wp-block-button__link wp-element-button">About us</a></div>
<!-- /wp:button --></div>
<!-- /wp:buttons --></div>
<!-- /wp:group -->

<!-- wp:spacer {"height":"var:preset|spacing|30","style":{"layout":[]}} -->
<div style="height:var(--wp--preset--spacing--30)" aria-hidden="true" class="wp-block-spacer"></div>
<!-- /wp:spacer -->

<!-- wp:image {"align":"wide","sizeSlug":"full","linkDestination":"none","className":"is-style-rounded"} -->
<figure class="wp-block-image alignwide size-full is-style-rounded"><img src="/wp-content/themes/twentytwentyfour/assets/images/building-exterior.webp" alt="Building exterior in Toronto, Canada"/></figure>
<!-- /wp:image --></div>
<!-- /wp:group -->

',
							);
						}

					} else {
						$page = get_page_by_path( ${js.path} );
					}
					echo $page->post_content;
					`
				});
				console.log(r, r.text);
				return r.text;
			},

			update_page_contents: async function( vars ) {
				const js = phpVars( vars );
				await client.isReady;
				return await client.run({
					code: `<?php
					require("/wordpress/wp-load.php");
					if ( ${js.path} === '/' || ${js.path} === 'frontpage' || ${js.path} === '/frontpage' ) {
						register_post_type('wp_template');
						register_taxonomy('wp_theme','wp_template');
						$posts = get_posts( array(
							'post_name' => 'home',
							'post_type' => 'wp_template',
						) );
						if ( ! empty($posts)) {
							$page = $posts[0];
							$page->post_content = ${js.post_content};
							$id = wp_update_post( $page );
						} else {
							$data = array(
								'post_content'=> ${js.post_content},
								'post_title' => 'Blog Home',
								'post_name' => 'home',
								'post_status' => 'publish',
								'post_type' => 'wp_template',
								'meta_input' => array( 'origin' => 'theme' ),
							);
							$page = get_page_by_path( 'home', ARRAY_A, 'wp_template');
							if ( $page ) {
								$data['ID'] = $page['ID'];
							}
							$id = wp_insert_post( $data );
							if ( ! is_wp_error( $id ) ) {
								wp_set_post_terms( $id, 'twentytwentyfour', 'wp_theme' );
							}
						}
					} else {
						$page = get_page_by_path( ${js.path} );
						$page->post_content = ${js.post_content};
						$id = wp_update_post( $page );
					}
					echo ${js.post_content};
					`
				}).text;

			}
		}

		async function openAI( data, callback ) {
				const endpoint = 'https://api.openai.com/v1/chat/completions';
				data.functions = [
				{
					name: "get_page_contents",
					description: "Get the contents of the given relative URL of the WordPress site",
					parameters: {
						type: "object",
						properties: {
							path: {
								type: "string",
								description: "The relative URL",
							},
						},
						required: [ 'path' ],
					}
				},
				{
					name: "update_page_contents",
					description: "Update the contents of the given relative URL of the WordPress site with the given post_content",
					parameters: {
						type: "object",
						properties: {
							path: {
								type: "string",
								description: "The relative URL",
							},
							post_content: {
								type: "string",
								description: "The WordPress post_content to be saved",
							},
						},
						required: [ 'path', 'post_content' ],
					}
				},

				];

				try {
					// Send POST request to OpenAI API
					const response = await fetch(endpoint, {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${apiKey}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(data)
					});

					const responseData = await response.json();
					if ( responseData.choices[0].message.function_call ) {
						data.messages.push( responseData.choices[0].message );
						if ( openai_functions[responseData.choices[0].message.function_call.name] ) {
							const content = await openai_functions[responseData.choices[0].message.function_call.name]( JSON.parse( responseData.choices[0].message.function_call.arguments ) );
							data.messages.push( {
								role: 'user',
								name: responseData.choices[0].message.function_call.name,
								content: content,
							} );
							if ( 'update_page_contents' === responseData.choices[0].message.function_call.name ) {
								return callback( content );
							}
							return openAI( data, callback );

						}
					}
					callback(responseData.choices[0].message.content);
				} catch (error) {
					console.error('Error:', error);
				}
			}


		document.getElementById('upload-image').addEventListener('submit', async function(e) {
			e.preventDefault();
			const form = e.target;
			const b = form.querySelector('button')
			const file = document.getElementById('image-upload').files[0];
			const base64Image = await readFileAsBase64(file);

			const li = getChatLi( 'Alex', 'Make the page look like this image:' );
			const bot = getChatLi( 'Bot' );
			const img = document.createElement( 'img' );
			img.src = 'data:image/jpeg;base64,' + base64Image;
			img.style.display="block";
			img.style.maxHeight="100px";
			li.appendChild( img );
			const m = document.getElementById( 'messages' );
			m.appendChild( li );
			m.appendChild( bot );
			m.scrollTop = m.scrollHeight;
			if ( ! apiKey ) {
				bot.removeChild( document.getElementById('spinner') );
				const s = document.createElement( 'span' );
				s.textContent = 'No OpenAI key set.';
				bot.appendChild(s);
				return;
			}
			b.disabled = true;
			form.disabled = true;
			const data = {
				messages: [
					{
						role: 'user',
						content: [
							{ type: 'text', text: 'please respond with the pure html (no outside comments or html markers) that can be used in the wordpress block editor that resembles this image and do use the gutenberg-style html comments that delimit blocks. ensure to set the background color' },
							{ type: 'image_url', image_url: 'data:image/jpeg;base64,' + base64Image }
						]
					}
				],
				model: 'gpt-4-vision-preview',
				max_tokens: 1000,
				temperature: 0.7
			};

			openAI(data, async function(result) {
				await updateFrontpage( result );
				bot.removeChild( document.getElementById('spinner') );
				const details = document.createElement( 'details' );
				const summary = document.createElement( 'summary' );
				const c = document.createElement( 'code' );
				summary.textContent = 'Done!';
				c.textContent = result;
				details.appendChild(summary)
				details.appendChild(c);
				li.appendChild( details );
			} ).then(()=>{b.disabled = false;form.disabled = false;})
		});

	});

	function readFileAsBase64(file) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.readAsDataURL(file);

			reader.onload = () => resolve(reader.result.split(',')[1]);
			reader.onerror = error => reject(error);
		});
	}

	const client = await startPlaygroundWeb({
		iframe: document.getElementById('wp'),
		remoteUrl: 'https://playground.wordpress.net/remote.html',
		blueprint: {
			steps: [
			// 	{
			// 	"step": "installPlugin",
			// 	"pluginZipFile": {
			// 		"resource": "wordpress.org/plugins",
			// 		"slug": "sql-buddy"
			// 	},
			// 	"options": {
			// 		"activate": true
			// 	}
			// },
			{
				"step": "login",
				"username": "admin",
				"password": "password"
			}
			]
		}
	});
	client.onNavigation((url)=>{console.log(url);});
	await client.isReady;
	document.getElementById( 'messages' ).appendChild( getChatLi( 'Bot', 'Ready! How can I help you?' ));

	async function updateFrontpage(result) {
		const regex = /```(?:html)?([\s\S]*?)```/;
		const matches = result.match(regex);
		let html;
		if (matches) {
			html = matches[1]
		} else if ( result.substring( 0, 4 ) === '<!--') {
			html = result;
		}

		html = '<!-- wp:template-part {"slug":"header","theme":"twentytwentyfour","tagName":"header","area":"header"} /-->' + "\n" + html;
		const js = phpVars({html});
		await client.isReady;
		await client.run({
			code: `<?php
			require("/wordpress/wp-load.php");
			register_post_type('wp_template');
			register_taxonomy('wp_theme','wp_template');
			$data = array(
			'post_content'=> ${js.html},
			'post_title' => 'Blog Home',
			'post_name' => 'home',
			'post_status' => 'publish',
			'post_type' => 'wp_template',
			'meta_input' => array( 'origin' => 'theme' ),
			);
			$page = get_page_by_path( 'home', ARRAY_A, 'wp_template');
			if ( $page ) {
				$data['ID'] = $page['ID'];
			}
			$id = wp_insert_post( $data );
			if ( ! is_wp_error( $id ) ) {
				wp_set_post_terms( $id, 'twentytwentyfour', 'wp_theme' );
			}

			`,
		});
		client.goTo('/');
	}
	async function executeCode( result ) {
		const regex = /```(?:php)?([\s\S]*?)```/;
		const matches = result.match(regex);
		let code;
		if (matches) {
			code = matches[1]
		} else if ( result.substring( 0, 5 ) === '<?php') {
			code = result;
		} else if ( result.match(/ = /) ) {
			code = '<?php ' + result;
		}
		if ( code ) {
			console.log('Executing', code);
			await client.isReady;
			await client.run({
				code,
			});
			client.goTo('/');
		} else {
			console.log('error',result,matches);
		}

		return code;
	}

</script>
	</div>
</body>
</html>
